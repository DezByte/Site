<?php

    /**
    *
    * Generated by DezDevTools @ 2016-03-13 17:35:06
    *
    * @author Ivan Gontarenko
    * @licence MIT
    *
    */

    namespace SiteDezz\Model\Entity;

    use Dez\ORM\Collection\ModelCollection;
    use Dez\ORM\Model\QueryBuilder;
    use SiteDezz\Model\Entity\GeneratedEntity\Entity_dba5d91846ce1a5e63734dfcbcb481cb;

    class Articles extends Entity_dba5d91846ce1a5e63734dfcbcb481cb
    {

        const STATUS_PUBLISHED = 'published';

        const STATUS_UNPUBLISHED = 'unpublished';

        /**
         * @return ModelCollection[ArticleTags]
         * @throws \Dez\ORM\Exception
         */
        public function tags()
        {
            return $this->hasMany(ArticleTags::class, 'article_id', 'id');
        }

        /**
         * @return ArticleCategories
         * @throws \Dez\ORM\Exception
         */
        public function category()
        {
            return $this->hasOne(ArticleCategories::class, 'id', 'category_id');
        }

        /**
         * @param string $tags
         * @return $this
         */
        public function createTags($tags)
        {
            ArticleTags::query()->where('article_id', $this->id())->delete();

            $tags = array_map(function($tag){
                return trim($tag);
            }, explode(',', $tags));

            foreach ($tags as $tag) {
                (new ArticleTags())
                    ->setArticleId($this->id())->setName($tag)->setTag(\URLify::filter($tag))
                    ->save(true);
            }

            return $this;
        }

        /**
         * @return QueryBuilder
         */
        public static function popular()
        {
            return static::query()->order('views', 'desc');
        }

        /**
         * @return QueryBuilder
         */
        public static function published()
        {
            return static::query()->where('status', static::STATUS_PUBLISHED);
        }

    }